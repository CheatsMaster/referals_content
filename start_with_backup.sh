#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º B2 –∫–ª—é—á–∏
if [ -z "$B2_KEY_ID" ] || [ -z "$B2_APP_KEY" ]; then
    log "‚ö†Ô∏è  –ë—ç–∫–∞–ø—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã (–Ω–µ—Ç –∫–ª—é—á–µ–π B2)"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
    log "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
    exec python bot.py
fi

log "‚úÖ –ë—ç–∫–∞–ø—ã –≤ B2 –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

# –£–ë–ï–î–ò–¢–ï–°–¨ —á—Ç–æ –±—ç–∫–∞–ø-—Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω
pkill -f "backup_to_b2.py" 2>/dev/null || true
pkill -f "hourly_backup.py" 2>/dev/null || true

# –ó–∞–ø—É—Å–∫–∞–µ–º –û–î–ò–ù –ø—Ä–æ—Ü–µ—Å—Å –±—ç–∫–∞–ø–æ–≤ –≤ —Ñ–æ–Ω–µ
log "üîÑ –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã –±—ç–∫–∞–ø–æ–≤..."
python hourly_backup.py > /tmp/backup.log 2>&1 &
BACKUP_PID=$!

# –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã —á—Ç–æ–±—ã –±—ç–∫–∞–ø-—Å–µ—Ä–≤–∏—Å —Ç–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±—ç–∫–∞–ø-—Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç
if ps -p $BACKUP_PID > /dev/null; then
    log "üì¶ –°–ª—É–∂–±–∞ –±—ç–∫–∞–ø–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞ (PID: $BACKUP_PID)"
else
    log "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É –±—ç–∫–∞–ø–æ–≤"
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞ (foreground –ø—Ä–æ—Ü–µ—Å—Å)
log "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
exec python bot.py
